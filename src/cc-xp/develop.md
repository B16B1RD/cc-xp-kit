---
description: XP develop – Evidence-Driven TDD（証拠駆動）による仮説検証強制実装
argument-hint: '[id] ※省略時は in-progress ストーリーを使用'
allowed-tools: Bash(git:*), Bash(date), Bash(test), Bash(bun:*), Bash(npm:*), Bash(pnpm:*), Bash(uv:*), Bash(python:*), Bash(pytest:*), Bash(cargo:*), Bash(go:*), Bash(bundle:*), Bash(dotnet:*), Bash(gradle:*), Bash(npx:*), Bash(ls), WriteFile, ReadFile, mcp__playwright__*
---

## ゴール

**Evidence-Driven TDD** により、仮説検証と受け入れ条件を強制的に満たすソフトウェアを実装する。従来の「テスト駆動開発」から「証拠駆動開発」へ変革し、ビジネス価値の実現を確実にする。

## 重要：強制実行原則

このコマンドは以下の**強制実行原則**に従ってください：

- **進行禁止**: 必須条件を満たすまで次フェーズへの進行を禁止する
- **証拠要求**: 実測値による証拠なしには完了を認めない
- **仮説検証**: 仮説が実証されない実装は失格とする
- **全項目実装**: 受け入れ条件1項目でも未実装なら停止する

## Phase 0: 開発前強制準備チェック

**以下すべて完了まで、Red Phase 開始を禁止してください：**

### 1. 仮説検証準備強制確認

```
□ backlog.yaml の `hypothesis` が具体的検証可能な仮説であることを確認
□ `kpi_target` が数値基準を含む測定可能な目標であることを確認
□ `success_metrics` が具体的テスト項目をリスト化していることを確認
□ 各項目が実装・測定可能で曖昧さがないことを確認
```

### 2. 受け入れ条件抽出強制確認

```
□ ストーリーファイル(@docs/cc-xp/stories/[ID].md)のすべてのGiven-When-Then項目を抽出
□ 各受け入れ条件が実装可能で具体的であることを確認
□ 抽出された条件をリスト化して表示
□ 曖昧な条件がある場合は明確化を要求
```

### 3. 開発環境確認

```
□ 適切なテストツールが利用可能であることを確認
□ 必要な依存関係がインストール済みであることを確認
□ Git環境が正常動作することを確認
```

**準備不備時の処理**:
"Phase 0 準備不備により Red Phase 開始不可 - [具体的未完了項目]" を表示して処理を停止

## Phase 1: Evidence-First Red（証拠収集優先失敗テスト）

**以下すべて完了まで、Green Phase 進行を禁止してください：**

### 1. 仮説検証テスト作成強制確認

```
□ backlog.yaml の `hypothesis` から検証すべき証拠を特定済み
□ 仮説を実測値で検証するテストコードを作成済み
□ テストが実際の証拠データを収集可能であることを確認済み
□ ハードコーディング値ではなく実測値を取得するテストであることを確認済み
```

### 2. KPI測定テスト作成強制確認

```
□ `kpi_target` から測定すべき実測値を特定済み
□ KPI目標を数値で検証するテストコードを作成済み
□ `success_metrics` のすべて項目に対する測定テストを作成済み
□ 各KPI測定が実装による実測値で行われることを確認済み
```

### 3. 受け入れ条件テスト作成強制確認

```
□ すべてのGiven条件に対する前提状態設定テストを作成済み
□ すべてのWhen操作に対する動作実行テストを作成済み
□ すべてのThen期待結果に対する検証テストを作成済み
□ すべてのAnd追加条件に対する補足テストを作成済み
```

### 4. Red状態確認

```
□ 作成されたすべてのテストが失敗（Red状態）であることを確認済み
□ 各テストが適切にFailure messageを表示することを確認済み
□ 失敗理由が「実装未完了」であることを明確に確認済み
```

**Red Phase 未完了時の処理**:
"Red Phase 未完了 - [未完了項目] により Green Phase 進行不可"
具体的な追加作業を明示して Green Phase 進行を停止

## Phase 2: Hypothesis-Driven Green（仮説検証実装）

**以下すべて達成まで、Refactor Phase 進行を禁止してください：**

### 1. 仮説検証実装強制確認

```
□ `hypothesis` の内容が実装により実証されていることを確認
□ 仮説検証テストがすべて成功状態になることを確認
□ 実装が仮説の核心部分を実際に証明していることを確認
□ 競合差別化要因が実装で実現されていることを確認
```

### 2. KPI目標達成強制確認

```
□ `kpi_target` で設定された数値基準を実測値が上回ることを確認
□ `success_metrics` のすべて項目が成功基準を満たすことを確認
□ KPI測定値がハードコーディングでなく実装による実測値であることを確認
□ KPI達成データが記録され後で検証可能な状態であることを確認
```

### 3. 受け入れ条件満足強制確認

```
□ すべてのGiven前提条件が実装で正しく設定されることを確認
□ すべてのWhen操作が実装で正しく実行されることを確認
□ すべてのThen期待結果が実装で正しく実現されることを確認
□ すべてのAnd追加条件が実装で満たされることを確認
```

### 4. 証拠データ記録強制確認

```
□ 仮説検証の証拠データが適切に記録されることを確認
□ KPI測定データが適切に保存されることを確認
□ 受け入れ条件満足の証拠が確認可能な状態であることを確認
```

**必須証拠データ表示**:
```
仮説検証状況:
- 仮説: [hypothesis内容]
- 検証結果: [実測による証拠]
- 証明状況: [成功/失敗]

KPI達成状況:
- [KPI項目1]: 目標[数値] vs 実測[数値] → [達成/未達成]  
- [KPI項目2]: 目標[数値] vs 実測[数値] → [達成/未達成]
- 総合達成率: [X]% (100%必須)

受け入れ条件満足状況:
- Given項目: [X]/[総数] 満足
- When項目: [X]/[総数] 満足
- Then項目: [X]/[総数] 満足
- 総合満足率: [X]% (100%必須)
```

**Green Phase 未達成時の処理**:
"Green Phase 未達成 - [具体的未達成項目] により Refactor Phase 進行不可"
未達成項目の実測値と目標値を明示して Refactor Phase 進行を停止

## Phase 3: Value-Maximizing Refactor（価値最大化最適化）

**以下すべて維持まで、開発完了を禁止してください：**

### 1. 証拠データ維持強制確認

```
□ 仮説検証テストが引き続きすべて成功状態であることを確認
□ KPI実測値が引き続き目標値以上を維持していることを確認
□ 受け入れ条件がすべて引き続き満たされていることを確認
□ すべての証拠データが最新状態で記録されていることを確認
```

### 2. 価値向上実装

```
□ business_value指標の維持または向上を確認
□ user_value指標の維持または向上を確認
□ 競合差別化要因の維持または強化を確認
□ 収集された証拠データを分析し改善余地があれば最適化を実施
```

### 3. 品質最適化

```
□ コードの可読性・保守性を向上（但し証拠データを維持）
□ パフォーマンスの最適化（但しKPI目標を維持）
□ エラーハンドリングの強化
□ ログ・監視機能の充実
```

**Refactor Phase 未完了時の処理**:
"Refactor Phase 未完了 - [劣化項目] により開発完了不可"
リファクタリング前後の証拠データ比較を表示

## 失敗時診断システム

開発が停止した場合、以下の診断を実行してください：

### 診断テンプレート

```
🚫 開発失敗診断
================
失敗タイプ: [仮説検証失敗/KPI達成失敗/受け入れ条件失敗/テスト実装失敗]
失敗フェーズ: [Red/Green/Refactor]

詳細診断:
❌ 失敗項目: [具体的項目名]
📊 現在状態: [実測値/状態]
🎯 要求状態: [目標値/状態]
📋 差分詳細: [不足分の具体的内容]

根本原因:
🔍 [技術的・概念的原因分析]

修正方針:
1. [優先度高] [具体的修正方法1]
2. [優先度中] [具体的修正方法2]
3. [優先度低] [具体的修正方法3]

再実行指示:
[修正後の次のステップ]
```

### 修正優先度の判定基準

- **優先度高**: 仮説検証・KPI達成・受け入れ条件に直接影響
- **優先度中**: 品質・パフォーマンス・保守性に影響
- **優先度低**: 将来の拡張性・最適化に影響

## 完了サマリー

Evidence-Driven TDD サイクル完了後、**必ず以下を表示**してください：

```
🎯 Evidence-Driven TDD 完了
========================
ストーリー: [ストーリータイトル]
仮説: [hypothesis内容]
ブランチ: story-[ID]

仮説検証結果:
✅ 仮説実証: [実証内容]
✅ 証拠収集: [収集された証拠データ]
✅ 競合差別化: [実現された差別化要因]

KPI達成状況:
✅ [KPI項目1]: 目標[数値] → 実測[数値] (達成率[X]%)
✅ [KPI項目2]: 目標[数値] → 実測[数値] (達成率[X]%)
✅ 総合KPI達成率: [X]% (100%必須)

受け入れ条件満足状況:
✅ Given条件: [X]/[総数] 満足 (100%)
✅ When条件: [X]/[総数] 満足 (100%)
✅ Then条件: [X]/[総数] 満足 (100%)
✅ 総合満足率: 100%

実施フェーズ:
✅ Evidence-First Red - 証拠収集テスト作成
✅ Hypothesis-Driven Green - 仮説検証実装  
✅ Value-Maximizing Refactor - 価値最大化最適化

証拠データ保存場所:
📁 [テストファイル場所]
📁 [KPI測定データ場所]
📁 [ログファイル場所]

使用ツール: [検出されたテストツール] 
```

## 次のステップ

開発完了後、**必ず以下を表示**してください：

```
🚀 次のステップ
================
動作確認とレビューを実施:
→ /cc-xp:review

レビューで以下を選択できます:
• accept - 仮説検証・KPI達成・受け入れ条件がすべて満足
• reject "理由" - 証拠不十分・目標未達・条件未満足により修正要求
• skip - 判定を保留

💡 重要な確認ポイント
- 仮説が実測値で実証されているか
- KPI目標が100%達成されているか  
- 受け入れ条件がすべて実装で満たされているか
- 証拠データが後で検証可能な状態か
```

## エラーハンドリング

以下のエラーが発生した場合の対応：

### テストツールが見つからない場合

- 利用可能なテストツールを検索
- インストール方法を提示
- 代替ツールを提案

### テストが最初から成功する場合

- Red Phase のやり直しを指示
- より厳密なテストの作成を要求
- 実装削除を提案

### KPI測定が不可能な場合

- KPI目標の見直しを提案
- 測定可能な代替指標を提案
- ストーリー仕様の修正を要求

### 仮説が検証不可能な場合

- 仮説の具体化を要求
- 検証可能な仮説への修正を提案
- 証拠収集方法の明確化を要求

## 重要な注意事項

- **強制停止**: 条件未満足時は必ず処理を停止する
- **証拠要求**: 実測値なしには完了を認めない
- **全項目実装**: 受け入れ条件の部分実装は失格
- **ハードコーディング禁止**: 偽装KPI測定は即座に却下
- **仮説証明必須**: 仮説が実証されない実装は無価値

このEvidence-Driven TDDにより、真の価値を実現するソフトウェア開発を確実に実行してください。