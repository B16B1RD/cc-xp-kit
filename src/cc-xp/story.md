---
description: XP story – ユーザーストーリーを詳細化（対話重視）
argument-hint: '[id] ※省略時は最初の selected を使用'
allowed-tools: Bash(date), Bash(echo), Bash(git:*), Bash(test), Bash(grep), ReadFile, WriteFile
---

# XP Story - ユーザーストーリー詳細化

## ゴール

ストーリーを**ユーザーとの対話**として詳細化し、明確な受け入れ条件を定義する。

## XP原則

@shared/xp-principles.md

## 共通処理

@shared/git-check.md

### 現在の状態確認

@shared/backlog-reader.md

### 対象ストーリーの特定

$ARGUMENTS が指定されている場合はその ID、なければ最初の `selected` ステータスのストーリーを使用してください。

**ステータスバリデーション**：
- 対象ストーリーが `selected` であることを確認
- すでに `in-progress` 以降のステータスの場合は、そのまま継続するか確認
- `done` ステータスのストーリーは詳細化不可

### AI分析レポートの参照

**重要**: ストーリー詳細化前に、plan.md で生成された AI 分析結果を必ず参照してください。

@docs/cc-xp/analysis_summary.md が存在する場合：
- 市場・競合分析結果を確認
- ペルソナ定義を参照  
- 収益化戦略を把握
- 差別化要因を理解

存在しない場合は、限定的なストーリー詳細化のみ実行してください。

## フィーチャーブランチの作成

### ブランチの確認

- 既存ブランチ一覧: !git branch -a

**ブランチ作成手順**：

1. `story-[ID]`形式のブランチが既に存在するか確認してください
2. **既存の場合**: ユーザーにチェックアウトするか確認してください
3. **新規作成の場合**: `story-[ID]`ブランチを作成し、チェックアウトしてください

ブランチ作成に失敗した場合は、同名ブランチの存在や未コミット変更の有無を確認してください。

## 受け入れ基準の詳細化（最重要）

### ユーザーとの対話による受け入れ基準の改善

ストーリー詳細化では、**acceptance_criteria** をユーザーとの対話を通じて具体化・改善することが最重要です。

#### 1. 既存受け入れ基準の確認

backlog.yamlから対象ストーリーの `acceptance_criteria` を確認し、以下を評価してください：

- **具体性**: 実装者が何を作るべきか明確か
- **検証可能性**: 実装後に動作確認できるか
- **完全性**: minimum_experienceを完全にカバーしているか
- **ユーザー視点**: 技術仕様ではなく体験の観点か

#### 2. ユーザーとの対話による改善

ユーザーに以下を確認し、受け入れ基準を改善してください：

**質問例**:
```
「ページを開いたとき、最初に何が見えることを期待していますか？」
「操作したとき、どのような反応が返ってくることを期待していますか？」
「この機能が正しく動いていることを、どうやって確認できますか？」
「もしエラーが起きたら、どのように表示されるべきですか？」
```

#### 3. 受け入れ基準の具体化

対話結果を基に、以下の観点で受け入れ基準を具体化してください：

**出力・表示の確認**:
- 何が、どこに、どのように表示されるか
- 表示のタイミング（ページ読み込み時、操作時等）
- 表示の継続時間や変化

**操作・インタラクションの確認**:
- どのような操作が可能か
- 操作に対する反応とその速度
- 無効な操作時の処理

**エラー・例外処理の確認**:
- どのような状況でエラーが発生するか
- エラー時の表示内容と処理
- 復旧方法や代替手段

#### 4. 実装検証可能性の保証

各受け入れ基準が以下を満たすことを確認してください：

- **実装判定可能**: 完成/未完成を明確に判定できる
- **定量的**: 時間、サイズ、位置等の具体的な値
- **環境非依存**: 特定の環境に依存しない

## ストーリー詳細化プロセス

### 1. 受け入れ基準の対話による改善

選択されたストーリーの `acceptance_criteria` をユーザーとの対話を通じて改善してください：

1. **現在の受け入れ基準をユーザーに提示**
   - backlog.yamlからacceptance_criteriaを読み上げ
   - 「この基準で、あなたが期待する価値体験がカバーされていますか？」と確認

2. **ユーザーの期待との比較**
   - 不足している基準があるか確認
   - 曖昧で改善が必要な基準があるか確認
   - 不要または重複している基準があるか確認

3. **対話による具体化**
   - ユーザーの回答を基に受け入れ基準を具体化
   - 実装後に検証可能な形式に変換

### 2. backlog.yamlの更新

改善された受け入れ基準をbacklog.yamlに反映してください：

```yaml
acceptance_criteria:
  - "具体化された受け入れ基準1"
  - "具体化された受け入れ基準2"
  - "追加された受け入れ基準3"
```

### 3. ストーリー詳細ファイルの生成

`docs/cc-xp/stories/[story-id].md` を生成し、詳細化の記録を残してください：

```markdown
# [Story Title]

## 受け入れ基準の詳細化記録

### 対話による改善内容
- [ユーザーとの対話で明らかになった点]
- [追加・修正された受け入れ基準の理由]

### 最終的な受け入れ基準
[backlog.yamlのacceptance_criteriaの内容]

### 実装時の検証項目
- [各受け入れ基準の確認方法]
- [価値体験の検証ポイント]

## 実装時の注意事項
- [価値体験実現のための重要なポイント]
- [技術的な制約や考慮事項]
```

### 4. ステータス更新

受け入れ基準の詳細化完了後、以下を実行してください：

1. backlog.yamlのストーリーステータスを `selected` から `in-progress` に更新
2. `updated_at` を現在時刻で更新
3. `acceptance_criteria` を改善された内容で更新
4. `development_notes` に詳細化の要点を追加

## 次のステップ

@shared/next-steps.md