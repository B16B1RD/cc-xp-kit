---
description: XP plan – 次のイテレーションを計画する（YAGNI原則：必要なものだけ）
argument-hint: '"ウェブブラウザで遊べるテトリスが欲しい"'
allowed-tools: Bash(date), Bash(echo), Bash(git:*), Bash(test), Bash(mkdir:*), Bash(cat), ReadFile, WriteFile
---

## ゴール

「$ARGUMENTS」から**最小限の価値あるストーリー**を抽出し、1〜2時間で完了できる小さなイテレーションを計画する。

## XP原則

- **シンプルさ**: 最もシンプルな解決策から始める
- **YAGNI**: 今必要なものだけを計画に入れる
- **小さなリリース**: 動くソフトウェアを素早く届ける
- **継続的インテグレーション**: 頻繁なコミットで進捗を共有

## 現在の状態確認

### Git環境
- リポジトリ状態確認: !test -d .git
- 現在のブランチ: !git branch --show-current
- 未コミット変更: !git status --short

### 未コミット変更の警告

未コミット変更がある場合（`git status --porcelain` の出力が空でない場合）、以下の警告を表示してください：

```
⚠️ 未コミットの変更が検出されました
=====================================

以下のファイルに変更があります：
[git status --short の出力をここに表示]

【推奨アクション】
1. 現在の変更をコミット:
   git add .
   git commit -m "現在の作業を保存"

2. 変更を一時的に退避:
   git stash push -m "計画前の作業"

3. 変更を破棄（注意！）:
   git checkout -- .

新しいイテレーション計画を開始する前に、
現在の作業を適切に処理することを推奨します。
```

### プロジェクト構造
- ディレクトリ確認: !test -d docs/cc-xp/stories
- backlog確認: !test -f docs/cc-xp/backlog.yaml
- metrics確認: !test -f docs/cc-xp/metrics.json

### E2Eテスト環境の確認

**MCP Playwright環境の検出**：
Claude Code環境でMCP Playwrightが利用可能かどうかを確認してください。利用可能な場合は以下を表示：

```
✅ MCP Playwright が利用可能です
==================================
以下の機能が使用できます：
• 自動ブラウザ操作
• スクリーンショット取得
• 要素の自動検出とクリック
• フォーム入力の自動化

WebアプリケーションのE2Eテストが自動実行されます。
```

**通常Playwright環境の検出**：
- Playwright設定確認: !test -f playwright.config.ts || test -f playwright.config.js
- package.json内Playwright確認: !grep -q "playwright" package.json 2>/dev/null || echo "not found"

利用可能な場合：
```
⚠️ 通常のPlaywrightが検出されました
=================================
MCP Playwrightは利用不可ですが、
通常のPlaywrightでE2Eテストを実行できます。

npx playwright test
```

**E2Eテスト非対応環境**：
両方とも利用不可の場合：
```
ℹ️ E2Eテスト環境が見つかりません
==============================
Webアプリケーションの場合は手動テストを推奨します。

次のツールの導入を検討してください：
• MCP Playwright（Claude Code環境）
• Playwright（npm install playwright）
```

### タイムスタンプ
- 現在時刻: !date +"%Y-%m-%dT%H:%M:%S%:z"
- イテレーションID: !date +%s

## AI要求分析フェーズ

### 1. 深層要求分析

ユーザーの「$ARGUMENTS」を以下の観点で**深層分析**してください：

#### 🎯 ユーザー価値分析
```
【質問例】
- この要求の背景にある真のニーズは何か？
- ユーザーが本当に解決したい問題は何か？
- 類似サービス・競合製品はどのような価値を提供しているか？
- この製品が成功した場合の具体的な成果指標は何か？

【分析フレームワーク】
1. ジョブ理論: ユーザーが「雇いたい」機能は何か
2. ペルソナ: 主要ユーザー層の特性と動機
3. ユースケース: 実際の使用シーンと頻度
4. 競合分析: 既存解決策との差別化要因
```

#### 🏢 ビジネス分析
```
【収益性分析】
- マネタイゼーション手法（広告、サブスク、課金等）
- 想定ユーザー数とLTV
- 開発・運用コストの概算
- 市場規模とシェア獲得戦略

【実現可能性分析】
- 技術的制約と解決策
- リーガルリスクと対応策
- 必要リソースと調達方法
- リリース後の継続改善体制
```

#### 🎨 UX戦略分析
```
【ユーザビリティ優先順位】
- 初回体験でのWow factor
- 習慣化を促すエンゲージメント要素
- 脱落防止のためのハードル設計
- リテンション向上のためのフィードバック機能
```

### 2. AI推奨ストーリー生成

上記分析を基に、**ビジネス価値を最大化する**ストーリー候補を生成してください：

#### 🚀 MVP戦略
- **仮説検証ストーリー**: 最小コストで核心価値を検証
- **エンゲージメント強化**: ユーザーの継続利用を促進
- **収益化準備**: マネタイゼーション基盤の構築

#### 📊 優先順位付けアルゴリズム
各ストーリーを以下で評価：
```
スコア = (ビジネス価値 × ユーザー価値) / (実装コスト × リスク)

- ビジネス価値: 1-10（収益・成長への貢献度）
- ユーザー価値: 1-10（ユーザー満足・リテンション向上）
- 実装コスト: 1-10（開発工数・複雑度）  
- リスク: 1-10（技術的・事業的リスク）
```

## タスク（従来の環境準備は3番に移動）

### 1. AI分析実行

**重要**: 以下の分析を必ず実行してからストーリー生成に進んでください：

```bash
# 分析結果を一時ファイルに保存
echo "=== ユーザー要求分析レポート ===" > analysis_report.tmp
echo "要求: $ARGUMENTS" >> analysis_report.tmp
echo "分析日時: $(date)" >> analysis_report.tmp
echo "" >> analysis_report.tmp
```

#### Phase 1-A: 市場・競合の深層分析

**必須分析項目**を以下の順序で実行してください：

```bash
# 分析結果の構造化記録
echo "## 市場分析結果" >> analysis_report.tmp
echo "分析対象: $ARGUMENTS" >> analysis_report.tmp
echo "" >> analysis_report.tmp
```

**1. 競合製品の特定と分析**
- 直接競合: 同じ機能・ターゲットの製品/サービス
- 間接競合: 同じ課題を異なる方法で解決している製品
- 潜在競合: 将来的に競合となりうる新興サービス

**各競合について以下を調査**：
```
競合名: [製品名]
強み: [3つまで]
弱み: [3つまで]
価格戦略: [収益モデル]
ユーザー数: [推定規模]
差別化チャンス: [我々が勝てる要因]
```

**2. 市場規模・成長性分析**
```
TAM (Total Addressable Market): [総市場規模]
SAM (Serviceable Addressable Market): [獲得可能市場]
SOM (Serviceable Obtainable Market): [現実的獲得市場]
市場成長率: [年間成長予測]
参入障壁: [技術・法規制・資本要件]
```

#### Phase 1-B: 戦略的ペルソナ定義

**データドリブン**なペルソナ作成：

```
## プライマリーペルソナ（最重要ユーザー）
名前: [具体的な人物像]
属性: [年齢・職業・収入・居住地域]
技術レベル: [初心者/中級者/上級者]
デバイス環境: [スマホ/PC/タブレット使用パターン]

## ペインポイント（現在の課題）
- 機能的ペイン: [作業効率・時間・コストの課題]
- 感情的ペイン: [ストレス・不安・不満]
- 社会的ペイン: [他者との関係・評価の課題]

## ゲインポイント（期待価値）  
- 機能的ゲイン: [効率向上・コスト削減・時間短縮]
- 感情的ゲイン: [達成感・安心感・楽しさ]
- 社会的ゲイン: [承認・評価・ステータス向上]

## 利用シーン分析
- 主要利用時間: [平日/休日、朝/昼/夜]
- 利用環境: [自宅/職場/移動中]
- 利用頻度: [毎日/週数回/月数回]
- セッション時間: [1回あたりの利用時間]
```

**セカンダリーペルソナ**（2-3個を簡潔に定義）

#### Phase 1-C: 収益化戦略設計

**多角的な収益モデル**を検討：

```
## 短期収益戦略（3ヶ月以内）
主収益源: [広告/課金/サブスク/EC等]
目標ARPU: [ユーザー単価]
必要DAU: [収益目標達成に必要な日間アクティブユーザー]

## 中期収益戦略（6-12ヶ月）
収益源多角化: [追加収益ストリーム]
LTV向上施策: [ライフタイムバリュー改善]
CAC最適化: [顧客獲得コスト削減]

## 長期収益戦略（1-3年）  
プラットフォーム化: [エコシステム構築]
データマネタイズ: [蓄積データの活用]
B2B展開: [企業向けサービス]
```

**重要指標の設定**：
```
KPI階層:
- 北極星指標: [事業の成功を表す最重要指標]
- 主要指標: [売上・利益・ユーザー数等]
- 先行指標: [主要指標に影響する予兆指標]
- 品質指標: [ユーザー体験・システム品質]
```

### 2. 戦略的ストーリー設計

分析結果を基に、**事業成功に直結する**ストーリーを設計：

#### 📈 成功指標の事前定義
各ストーリーに明確なKPIを設定：
```
- DAU/MAU目標値
- コンバージョン率目標
- NPS・満足度スコア目標
- 収益目標（該当する場合）
```

#### 🎯 仮説駆動開発
各ストーリーを検証すべき仮説として定義：
```
仮説: 「ユーザーは○○の状況で××機能を使用し、△△の価値を感じる」
検証方法: [具体的な測定手法]
成功基準: [定量的指標]
```

### 3. 環境の準備

必要に応じて以下を実行してください：

**Gitの初期化**（.gitディレクトリがない場合）
```bash
git init
```

**ディレクトリ構造の作成**（docs/cc-xp/storiesがない場合）
```bash
mkdir -p docs/cc-xp/stories
```

**metrics.jsonの初期化**（存在しない場合）
`docs/cc-xp/metrics.json` を以下の内容で作成：
```json
{
  "velocity": 0,
  "cycleTime": 0,
  "testCoverage": 0,
  "toolchain": "未設定",
  "completedStories": 0,
  "tddCycles": {
    "red": 0,
    "green": 0,
    "refactor": 0
  },
  "commitCount": 0,
  "lastUpdated": "[現在時刻]",
  "iterations": []
}
```

### 4. 戦略的ストーリー候補生成

**AI分析結果を統合**して、ビジネス成功確率を最大化するストーリーを生成：

#### 📋 ストーリー生成テンプレート
各ストーリーに必須項目を設定：

```yaml
- id: [イテレーションID + 連番]
  title: '[ビジネス価値主導のタイトル]'
  description: '[ユーザー視点での価値記述]'
  size: [1,2,3,5,8 - 実装コストではなく価値創出の難易度]
  business_value: [1-10 - 収益・成長への貢献度]
  user_value: [1-10 - ユーザー満足・エンゲージメント向上度]
  implementation_cost: [1-10 - 開発工数・技術的複雑度]
  risk_level: [1-10 - 事業・技術リスクの総合評価]
  kpi_target: '[具体的な成功指標]'
  hypothesis: '[検証すべき仮説]'
  value: [High/Medium/Low - 総合スコアによる自動判定]
  status: selected
  created_at: [現在時刻]
  updated_at: [現在時刻]
  iteration_id: [イテレーションID]
```

#### 🎯 必須ストーリーカテゴリ

**1. 核心価値検証ストーリー（必須）**
- ユーザーの最重要ニーズを最短で検証
- MVP機能の実装
- 初回体験の最適化

**2. エンゲージメント強化ストーリー**
- ユーザーの継続利用を促進
- フィードバック機能
- パーソナライゼーション

**3. 収益化準備ストーリー**
- マネタイゼーション基盤
- ユーザーデータ分析機能
- 拡張性のあるアーキテクチャ

**4. 競合差別化ストーリー**
- 独自性のある機能
- ユーザー体験の革新
- ネットワーク効果の創出

#### 📊 自動優先順位付け

生成した各ストーリーを以下のアルゴリズムで評価：

```
総合スコア = (business_value × user_value) / (implementation_cost × risk_level)

優先順位ランク:
- スコア > 2.5: High (最優先)
- スコア 1.0-2.5: Medium (重要)
- スコア < 1.0: Low (後回し)
```

推奨選択数:
- **3-5個のストーリー**を選択（合計ポイント8-13を目安）
- **必ず1個以上のHigh価値ストーリーを含める**
- **リスクレベル8以上は1個まで**に制限

#### 🔄 既存メトリクス活用

@docs/cc-xp/metrics.json が存在する場合：
- `velocity` フィールドから適切な合計ポイント算出
- `completedStories` から成功パターン分析
- `tddCycles` から開発効率予測

推奨合計ポイント: velocity ± 30%（事業価値重視で幅を拡大）

### 5. 技術戦略の決定

**ビジネス要件に最適化された**技術選択：

#### 🚀 技術選択基準
1. **Time-to-Market**: 最短でMVPを市場投入
2. **Scalability**: ユーザー増加に対応可能
3. **Maintainability**: 継続的な機能追加・改善
4. **Cost Efficiency**: 開発・運用コスト最適化

#### 💻 推奨技術スタック

**Webフロントエンド（推奨順）**
1. **Bun + Vite + React/Vue** - 高速開発・高性能
2. **Next.js/Nuxt.js** - SEO重視・エンタープライズ向け
3. **Pure HTML/CSS/JS** - 最小依存・最短リリース

**バックエンド（推奨順）**
1. **Bun + Hono** - 最高速度・最新技術
2. **Node.js + Express** - 豊富なエコシステム
3. **Python + FastAPI** - データ分析・AI統合

**データベース**
1. **SQLite** - プロトタイプ・小規模
2. **PostgreSQL** - スケーラブル・高機能
3. **MongoDB** - 柔軟なスキーマ・高速開発

**特別考慮事項**
- 「HTMLダブルクリックで起動」要件 → Pure HTML/CSS/JS強制選択
- 「リアルタイム性重視」 → WebSocket対応必須
- 「モバイル対応」 → PWA化必須

### 6. 戦略的backlog.yamlの作成/更新

**拡張された構造**で選定ストーリーを記録：

```yaml
# イテレーションメタデータ
iteration:
  id: [イテレーションID]
  created_at: [現在時刻]
  business_goal: "[このイテレーションで検証したい仮説]"
  success_criteria: "[成功判定基準]"
  target_users: "[想定ユーザー層]"

# ストーリーリスト
stories:
  - id: [イテレーションID + 001]
    title: '[ビジネス価値主導のタイトル]'
    description: '[ユーザー視点の価値記述]'
    size: [1-8]
    
    # 事業価値指標（新規追加）
    business_value: [1-10]
    user_value: [1-10] 
    implementation_cost: [1-10]
    risk_level: [1-10]
    priority_score: [計算値]
    
    # 仮説駆動項目（新規追加）
    hypothesis: "[検証すべき仮説]"
    kpi_target: "[具体的成功指標]"
    success_metrics: "[測定方法]"
    
    # 既存項目
    value: [High/Medium/Low] 
    status: selected
    created_at: [現在時刻]
    updated_at: [現在時刻]
    iteration_id: [イテレーションID]
    
    # 戦略コンテキスト（新規追加）
    user_persona: "[対象ユーザー]"
    business_context: "[事業上の位置づけ]"
    competition_analysis: "[競合との差別化要因]"
```

**ステータスの流れ**（変更なし）：
- `selected` (plan) → `in-progress` (story) → `testing` (develop) → `done` (review accept のみ)

### 6. 変更のコミット

以下のコマンドで変更をコミットしてください：

```bash
git add docs/cc-xp/backlog.yaml docs/cc-xp/metrics.json docs/cc-xp/analysis_summary.md
git commit -m "feat: 戦略的イテレーション計画 - [要望の最初の50文字]...

✨ AI駆動分析による価値最大化アプローチ
📊 ビジネス価値・ユーザー価値・実装コスト・リスクを定量評価
🎯 競合分析・ペルソナ・収益化戦略を統合
🔍 実用性検証チェックリスト完備"
```

### 8. AI分析レポートと戦略的サマリー

**必ず以下の構造化されたレポート**を表示してください：

```
🎯 AI要求分析レポート
====================
要求: "[ARGUMENTS]"
分析日時: [現在時刻]

【深層ニーズ分析】
核心的ユーザー価値: [分析結果]
主要ペルソナ: [ユーザー層]
競合差別化要因: [独自性]

【ビジネス戦略】
収益化手法: [マネタイゼーション]
市場ポジショニング: [差別化戦略]
スケール計画: [成長シナリオ]

📊 戦略的ストーリー選定結果
===========================
ID     | タイトル                    | 事業価値 | UX価値 | スコア | 仮説
------ | -------------------------- | -------- | ------ | ------ | ----
[ID]   | [ビジネス価値主導タイトル]    | [B]      | [U]    | [S]    | [仮説]

選定基準:
✅ 総合スコア2.5以上: [X]個
✅ 核心価値検証ストーリー: [X]個
✅ エンゲージメント強化: [X]個
✅ 収益化準備: [X]個

合計ポイント: [合計]
推定開発時間: [1-2時間] 
ビジネス成功確率: [High/Medium/Low]
技術スタック: [選択した技術]

🎲 検証すべき核心仮説
===================
[最も重要な仮説を1-2個記載]

📈 期待される成果
================
- 短期: [1-2週間以内の成果]
- 中期: [1-2ヶ月以内の成果] 
- 長期: [半年以内の成果]

🔍 実用性検証チェックリスト
========================
各ストーリーについて以下を確認済み:
✅ 実際に使われるユースケースが存在する
✅ 競合に対する明確な優位性がある  
✅ 収益化への道筋が見える
✅ 継続利用を促進する仕組みがある
✅ 技術的実現可能性が確保されている

🎯 次イテレーションでの検証項目  
============================
- ユーザー行動データ: [測定すべき指標]
- 収益指標: [追跡すべきKPI]
- 競合比較: [ベンチマーク項目]
- UX改善: [定性的フィードバック収集]
```

### 9. 改善されたstory.mdとの連携指示

**重要**: `/cc-xp:story`実行時に以下の情報を必ず引き継いでください：

```bash
# 分析レポートをstoryフェーズに引き継ぎ
if [ -f analysis_report.tmp ]; then
  cp analysis_report.tmp docs/cc-xp/analysis_summary.md
  echo "✅ AI分析レポートをstoryフェーズに引き継ぎ" 
fi
```

story.mdで以下を参照するよう指示：
- `docs/cc-xp/analysis_summary.md`: 市場・競合・ペルソナ分析
- `docs/cc-xp/backlog.yaml`: 拡張されたビジネス指標
- 各ストーリーの`hypothesis`と`kpi_target`を必ず活用

### 重要：次のコマンドを必ず明確に表示

```
🚀 次のステップ
================
最初のストーリーを詳細化:
→ /cc-xp:story

このコマンドで:
• ユーザーストーリーを作成
• 受け入れ条件を定義
• テスト戦略を決定

💡 開発の流れ
------------
1. story: ストーリー詳細化
2. develop: TDDサイクル（Red→Green→Refactor）
3. review: 動作確認と判定
4. retro: 振り返り（適宜）

すべてのコマンド:
• /cc-xp:story - ストーリー詳細化
• /cc-xp:develop - TDD開発
• /cc-xp:review - レビューと判定
• /cc-xp:retro - 振り返り
```

## 注意事項

- 未コミットの変更がある場合は警告を表示
- 初回実行時は環境構築ストーリーを必ず含める
- YAGNIを守り、必要最小限のストーリーに絞る
