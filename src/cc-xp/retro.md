---
description: XP retro – 振り返りと継続的改善
allowed-tools: Bash(date), Bash(echo), Bash(git:*), Bash(grep), Bash(wc:*), ReadFile, WriteFile
---

## ゴール

短いサイクルを振り返り、**次をもっと良く**するための学びを得る。

## XP原則

- **振り返り**: 定期的に立ち止まって改善
- **勇気**: 問題を直視し、変化を受け入れる
- **継続的改善**: 小さな改善を積み重ねる
- **透明性**: Gitログから客観的データを収集

## Gitメトリクスの収集

### イテレーション期間の特定
- 最初のplanコミット: !git log --reverse --grep="feat: イテレーション計画" --format="%at" -1
- 現在時刻（UNIX時間）: !date +%s

上記の差分から経過時間を計算してください。見つからない場合は、2時間前からを対象期間としてください。

### コミット統計の収集
- 総コミット数: !git log --oneline --since="2 hours ago"
- Redコミット数: !git log --oneline --since="2 hours ago" --grep="🔴"
- Greenコミット数: !git log --oneline --since="2 hours ago" --grep="✅"
- Refactorコミット数: !git log --oneline --since="2 hours ago" --grep="♻️"
- 完了ストーリー数: !git log --oneline --since="2 hours ago" --grep="✨"

### 変更統計の収集
- 変更ファイル数: !git diff --name-only main..HEAD
- 変更サマリー: !git diff --stat main..HEAD
- 頻繁に変更されたファイル: !git log --since="2 hours ago" --name-only --pretty=format:

## 戦略的メトリクス分析

### 拡張メトリクスファイルの確認

@docs/cc-xp/metrics.json から**従来と新規の両方の指標**を確認してください：

#### 従来指標
- 現在のベロシティ
- 平均サイクルタイム  
- 使用中のツールチェーン
- 過去のイテレーション履歴

#### 仮説駆動開発指標（新規）
```json
"hypothesisDriven": {
  "hypothesesTested": [検証した仮説数],
  "validatedHypotheses": [成功した仮説数], 
  "kpiMeasurements": {
    "game_startup_time": [実測値配列],
    "user_engagement": [実測値配列]
  },
  "businessValueRealized": [累積ビジネス価値],
  "competitiveAdvantages": [実現した差別化要因],
  "personas": [対応したペルソナ一覧]
}
```

**重要**: 新規指標が存在しない場合は旧形式として扱い、基本分析のみ実行してください。

### 戦略的バックログ分析

@docs/cc-xp/backlog.yaml から以下をカウント（**読み取りのみ、変更しない**）：

#### 基本カウント
- 完了ストーリー数（status: done）
- 進行中ストーリー数（status: in-progress/testing）
- 残りストーリー数（status: todo/selected）

#### 仮説検証成功率分析（拡張形式の場合）
- hypothesis_validation.status: "validated" のストーリー数
- KPI達成ストーリー数（kpi_measurements.status: "passing"）
- ビジネス価値実現度の平均値
- 競合優位性確認済みストーリー数

#### ペルソナ対応度分析
- 各user_personaごとのストーリー完了数
- ペルソナ別の価値実現度評価

**注意**: retro コマンドではステータスを変更しません。分析のみ実行します。

## 戦略的開発サイクル健全性の評価

収集したGitメトリクスと仮説検証データから、**2階層の健全性**を判定してください：

### 第1階層: ビジネス価値実現健全性（最重要）

**✅ 優秀**（戦略的成功）
- 仮説検証成功率 ≥ 80%
- KPI目標達成率 ≥ 80%
- ビジネス価値実現度 ≥ 7/10
- 競合優位性を複数確認済み

**⚠️ 要注意**（戦略的課題）
- 仮説検証成功率 50-79%
- KPI目標達成率 50-79%
- ビジネス価値実現度 4-6/10
- ペルソナニーズの部分的満足

**❌ 要改善**（戦略的失敗）
- 仮説検証成功率 < 50%
- KPI目標達成率 < 50%
- ビジネス価値実現度 < 4/10
- 競合優位性が未確認

### 第2階層: TDDサイクル技術健全性（従来通り）

**✅ 健全**
- Red、Green、Refactorのコミット数が同じ
- すべてのフェーズが実施されている
- コミット頻度が適切（5コミット以上）

**⚠️ 要注意**
- Refactorコミットが少ない（Greenの50%未満）
- コミット頻度が低い（3-4コミット）
- TDDサイクルがやや不完全

**❌ 要改善**
- Redコミットがない（テストファーストでない）
- Red/Greenの数が一致しない
- Refactorが全くない
- コミット数が極端に少ない（2以下）

### 総合評価ロジック

```
総合評価 = ビジネス価値実現健全性 × 0.7 + TDDサイクル健全性 × 0.3

理由: 技術的実装が完璧でも、ビジネス価値を実現できなければ失敗
逆に、多少技術的に粗くても、ユーザーに価値を提供できれば成功
```

## 戦略的振り返りの生成

### Good 👍（うまくいったこと）

**ビジネス価値観点**と**技術観点**から良かった点を**各3つ以内**でリストアップしてください：

#### 🎯 ビジネス価値面での成功
- 仮説検証成功率が高い（X%達成）
- KPI目標を上回る成果（例: 起動時間2.85秒 vs 目標3秒）
- ペルソナニーズへの的確な対応
- 競合優位性の明確な実現
- ユーザー価値の定量的な向上

#### 🔧 技術面での成功（従来通り）
- TDDサイクルを適切に実施
- 高いコミット頻度
- 適切なリファクタリング実施
- 完了したストーリー数が多い

### Bad 👎（改善が必要なこと）

#### 🎯 ビジネス価値面での課題
- 仮説検証の精度不足
- KPI測定の実装不備
- ペルソナ理解の浅さ
- 競合分析の不十分さ
- ビジネス価値実現度の低さ

#### 🔧 技術面での課題（従来通り）
- TDDサイクルの不完全さ
- リファクタリングのスキップ
- コミット頻度の低さ
- テスト不足

### Try 🚀（次に試すこと）

**優先順位付けされた**改善アクションを提案してください：

#### 🥇 最高優先（ビジネス価値向上）
- 仮説の精密化（より検証可能な仮説設計）
- KPI測定の自動化（リアルタイム測定システム）
- ペルソナインタビュー実施（実際のユーザーフィードバック取得）

#### 🥈 高優先（開発プロセス改善）
- 仮説検証テストファーストの徹底
- KPI達成度を含むリファクタリング
- ビジネス価値を意識した小さなステップ開発

#### 🥉 中優先（技術改善）
- ツールチェーンの最適化
- テスト自動化の改善
- コード品質の向上

## 拡張メトリクスの更新

### イテレーション情報の拡張記録

@docs/cc-xp/metrics.json のiterationsに**戦略的情報を含む**以下を追加：

```json
{
  "id": "[イテレーション開始時刻]",
  "completed_at": "[現在時刻]",
  "duration_seconds": [経過秒数],
  
  // 従来指標
  "commits": [コミット数],
  "stories_completed": [完了ストーリー数],
  "tdd_cycles": {
    "red": [Redコミット数],
    "green": [Greenコミット数], 
    "refactor": [Refactorコミット数]
  },
  
  // 戦略的指標（新規追加）
  "hypothesis_driven": {
    "hypotheses_tested": [このイテレーションで検証した仮説数],
    "hypotheses_validated": [成功した仮説数],
    "kpi_success_rate": [KPI目標達成率%],
    "business_value_average": [ビジネス価値実現度の平均],
    "competitive_advantages": [実現した差別化要因リスト],
    "personas_addressed": [対応したペルソナリスト]
  },
  
  // 総合評価
  "business_health": "[優秀/要注意/要改善]",
  "technical_health": "[健全/要注意/要改善]", 
  "overall_health": "[計算された総合評価]",
  
  // 学習内容
  "lessons_learned": {
    "business_successes": [ビジネス面での成功要因],
    "technical_successes": [技術面での成功要因],
    "business_improvements": [ビジネス面での改善点],
    "technical_improvements": [技術面での改善点]
  }
}
```

### 全体メトリクスの拡張更新

#### 従来メトリクス
- lastUpdated: 現在時刻
- completedStories: 累計を更新
- ベロシティの再計算（移動平均）

#### 戦略的メトリクス累積更新
```json
"hypothesisDriven": {
  "totalHypothesesTested": += [今回のテスト数],
  "totalValidatedHypotheses": += [今回の成功数],
  "overallKpiSuccessRate": [全期間通算の成功率],
  "cumulativeBusinessValue": += [今回実現した価値],
  "competitiveAdvantagesPerfected": [確立済みの優位性リスト],
  "personaCoverageRate": [対応済みペルソナ/全ペルソナ]
},
"businessHealthTrend": [直近5回のビジネス健全性推移],
"strategicLearnings": [戦略的な気付き・改善パターン]
```

## アクションアイテムの生成

`docs/cc-xp/action-items-[日付].md` を以下の内容で作成してください：

```markdown
# 改善アクションアイテム

生成日: [現在日時]
イテレーション: [ID]
健全性: [ステータス]

## 優先度: 高
- [ ] [最重要改善項目]

## 優先度: 中
- [ ] [改善項目]

## 優先度: 低
- [ ] [その他の改善項目]
```

## 変更のコミット

```bash
git add docs/cc-xp/metrics.json docs/cc-xp/action-items-*.md
git commit -m "docs: 📊 イテレーション振り返り - [日付]"
```

## 戦略的振り返りサマリーの表示

以下の**拡張された形式**で結果を表示してください：

```
🎯 戦略的イテレーション振り返り  
===============================

【ビジネス価値実現状況】
仮説検証成功率: [X%]（[成功数]/[検証数]）
KPI目標達成率: [X%]（平均実績 vs 目標）
ビジネス価値実現度: [X.X/10]（加重平均）
競合優位性: [確立済み要因リスト]
対応ペルソナ: [ペルソナ名リスト]

ビジネス健全性: [優秀/要注意/要改善] [絵文字]

【技術実装実績】
期間: [X]時間
コミット数: [数]
TDDサイクル: Red([数]) → Green([数]) → Refactor([数])
完了ストーリー: [数]（[ポイント]ポイント）
技術健全性: [健全/要注意/要改善] [絵文字]

総合健全性: [計算結果] [絵文字]

【Good 👍（成功要因）】
🎯 ビジネス価値面:
• [ビジネス成功要因1]
• [ビジネス成功要因2]

🔧 技術面:
• [技術成功要因1]
• [技術成功要因2]

【Bad 👎（改善課題）】
🎯 ビジネス価値面:
• [ビジネス課題1]
• [ビジネス課題2]

🔧 技術面:
• [技術課題1]
• [技術課題2]

【Try 🚀（優先順位付き改善）】
🥇 最高優先（ビジネス価値向上）:
• [最重要改善1]
• [最重要改善2]

🥈 高優先（開発プロセス改善）:
• [重要改善1]
• [重要改善2]

🥉 中優先（技術改善）:
• [技術改善1]
• [技術改善2]

📊 学習ダッシュボード:
アクションアイテム: docs/cc-xp/action-items-[日付].md
累積仮説検証成功率: [全期間通算%]
ビジネス価値創出トレンド: [上昇/横ばい/下降]

【開発統計】
変更ファイル: [数]
[変更行数サマリー]

【最頻変更ファイル】
[リスト（ビジネス価値への影響度を考慮した分析）]

【戦略的インサイト】
[このイテレーションから得られた戦略的な気付き・パターン]
```

## ツールチェーン最適化の提案

現在のツールチェーン（@docs/cc-xp/metrics.json）を確認し、より高速な代替案がある場合は提案してください：

- npm → Bun（JavaScript）
- pip → uv（Python）
- 通常のテスト → watch mode
- 手動ビルド → ホットリロード

## 次のステップの提案

@docs/cc-xp/backlog.yaml の状態から適切な次のアクションを**必ず明確に提案**してください：

```
🚀 次のステップ
================

[状況に応じて以下から選択、複数可]
```

### パターン1: 進行中ストーリーがある場合
```
【優先】開発を継続:
→ /cc-xp:develop
（in-progress ストーリー: [タイトル]）

修正が必要な場合は develop → review のサイクルを続ける
```

### パターン2: 選択済みストーリーがある場合
```
【優先】次のストーリーを詳細化:
→ /cc-xp:story
（selected ストーリー: [タイトル]）

詳細化後は develop → review → accept/reject のサイクル
```

### パターン3: 未選択ストーリーがある場合
```
【優先】次のイテレーション計画:
→ /cc-xp:plan
（残り [X] 個のストーリーあり）

新しいストーリーを選定して開発サイクルを継続
```

### パターン4: すべて完了の場合
```
🎉 すべてのストーリーが完了しました！

新しい要望を計画:
→ /cc-xp:plan "新機能の要望"

プロジェクトの成果物を確認:
• 完成したファイル: [リスト]
• 総コミット数: [数]
• 総開発時間: [時間]
```

### 共通の追加情報
```
💡 ワークフローのヒント
---------------------
• develop ↔ review は何度でも繰り返してOK
• 詰まったら別のストーリーに切り替えもあり
• 定期的な振り返りで改善を積み重ねる
• アクションアイテム: docs/cc-xp/action-items-[日付].md
```

## データ互換性とエラーハンドリング

### 旧形式プロジェクト対応

**重要**: 既存プロジェクトで戦略的情報が存在しない場合の対処法：

#### 自動判定と適応
```bash
# 戦略的データの存在確認
if grep -q "hypothesis" docs/cc-xp/backlog.yaml 2>/dev/null; then
  echo "✅ 拡張形式検出 - 戦略的振り返りを実行"
  ENHANCED_MODE=true
else
  echo "⚠️ 基本形式検出 - 従来振り返りのみ実行"
  ENHANCED_MODE=false
fi
```

#### フォールバック動作
- **hypothesis_driven** セクションが存在しない → 基本TDD分析のみ実行
- **backlog.yamlが旧形式** → ステータスカウントのみで戦略分析スキップ  
- **metrics.jsonが基本構造** → 従来指標のみで振り返り実行

#### 移行ガイダンス表示
```
ℹ️ 拡張機能のご案内
====================
このプロジェクトは従来形式で動作しています。

新機能（仮説駆動開発）を利用するには:
1. /cc-xp:plan で新しいイテレーション計画を作成
2. 自動的に拡張backlog.yaml構造に移行されます
3. 以降のストーリーでKPI分析・競合分析が利用可能

従来機能は引き続き完全にサポートされます。
```

### エラー時の安全な動作
- JSON解析エラー → デフォルト値で継続実行  
- YAML読み取りエラー → ファイル再生成を提案
- 計算エラー → 該当部分をスキップして他の分析を継続

## 注意事項

- メトリクスは客観的データに基づく
- 改善提案は具体的で実行可能に
- 良い点も必ず認識して記録する
- **互換性**: 旧プロジェクトでも基本機能は完全動作
- **移行**: 段階的な機能拡張をサポート
